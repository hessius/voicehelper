<html>
  <head>
    <title>Loading</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script>
      let domainList = {
        im: {
          url: 'https://www.internetmedicin.se/?s=',
          name: 'Internet Medicin',
          lang: 'sv'
        },
        internetmedicin: {
          url: 'https://www.internetmedicin.se/?s=',
          name: 'Internet Medicin',
          lang: 'sv'
        },
        pm: {
          url: 'https://www.praktiskmedicin.se/?s=',
          name: 'Praktisk Medicin',
          lang: 'sv'
        },
        praktiskmedicin: {
          url: 'https://www.praktiskmedicin.se/?s=',
          name: 'Praktisk Medicin',
          lang: 'sv'
        },
        fass: {
          url: 'https://www.fass.se/LIF/result?&userType=0&query=',
          name: 'FASS',
          lang: 'sv'
        },
        u2d: {
          url: 'https://www.uptodate.com/contents/search?search=',
          name: 'Uptodate',
          lang: 'en'
        },
        utd: {
          url: 'https://www.uptodate.com/contents/search?search=',
          name: 'Uptodate',
          lang: 'en'
        },
        uptodate: {
          url: 'https://www.uptodate.com/contents/search?search=',
          name: 'Uptodate',
          lang: 'en'
        },
        google: {
          url: 'https://www.google.com/search?q=',
          name: 'Google'
        },
        g: {
          url: 'https://www.google.com/search?q=',
          name: 'Google'
        },
        ji: {
          url: 'https://janusinfo.se/ovrigt/sokresultat.html?query=',
          name: 'JanusInfo',
          lang: 'sv'
        },
        janusinfo: {
          url: 'https://janusinfo.se/ovrigt/sokresultat.html?query=',
          name: 'JanusInfo',
          lang: 'sv'
        },
        lmb: {
          url:
            'https://lakemedelsboken.se/?iso=true&imo=false&nplId=null&search=',
          name: 'Lakemedelsboken',
          lang: 'sv'
        },
        lakemedelsboken: {
          url:
            'https://lakemedelsboken.se/?iso=true&imo=false&nplId=null&search=',
          name: 'Lakemedelsboken',
          lang: 'sv'
        },
        icd: {
          url: 'https://ekg.nu/icd-10-sok/?_searchicd=',
          name: 'ICD 10 - Ekg.nu',
          lang: 'sv'
        }
      }
      let url, translate, slang, tlang
      document.addEventListener('DOMContentLoaded', function () {
        function handlePaste (e) {
          var clipboardData, pastedData
          e.stopPropagation()
          e.preventDefault()
          clipboardData = e.clipboardData || window.clipboardData
          pastedData = clipboardData.getData('Text')
          console.log('Pasted: ' + pastedData)
          if (pastedData && url) {
            document.title = 'Redirecting'

            if (translate) {
              console.log('Translating')
              console.log(pastedData)
              console.log(slang)
              console.log(tlang)
              translateQuery(pastedData, slang, tlang)
            } else {
              url = url + pastedData
              window.location.href = url
            }
          }
        }
        document.addEventListener('paste', handlePaste)
        let urlParams = new URLSearchParams(window.location.search)
        let site = urlParams.get('site')
        let lang = urlParams.get('lang')
        if (site) {
          console.log('site param: ' + site)
          if (domainList[site]) {
            url = domainList[site].url
            if (
              domainList[site].lang &&
              lang &&
              domainList[site].lang !== lang
            ) {
              translate = true
              slang = lang
              tlang = domainList[site].lang
            } else {
              translate = false
            }
          } else if (site.startsWith('http')) {
            url = site
          }
        } else {
          console.error('site param is empty')
        }
        document.title = 'DMOhelper Ready'
      })
      function translateQuery (text, sourcelang, translationlang) {
        let translationurl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourcelang}&tl=${translationlang}&dt=t&q=${text}`
        fetch(translationurl)
          .then(response => response.json())
          .then(data => {
            let translatedText = data[0][0][0]
            url = url + translatedText
            window.location.href = url
          })
      }
    </script>
  </body>
</html>
